#' Plot visual information related to a tvcure object.
#' @description Visualization of the estimated additive terms and of the reference (cumulative) hazard function in a tvcure object.
#'
#' @usage \method{plot}{tvcure}(x, ngrid=300, ci.level=.95, pages=0, select=NULL,
#'                              equal.ylims=TRUE, ylim1=NULL, ylim2=NULL, ...)
#'
#' @param x a \code{\link{tvcure.object}}.
#' @param ngrid (optional) number of points used to plot the fitted additive terms. (Default: 300).
#' @param ci.level (optional) nominal level for the plotted pointwise credible intervals. (Default: 0.95).
#' @param pages The number of pages over which to spread the output. For example, if pages=1 then all terms will be plotted on one page with the layout performed automatically. Set to 0 to have the routine leave all graphics settings as they are. (Default 0).
#' @param select Allows the plot for a single model term to be selected for printing. e.g. if you just want the plot for the second smooth term set select=2. The plot of the reference hazard \eqn{f_0(t)} and cumulative hazard \eqn{F_0(t)} functions is provided when select=0. (Default: NULL).
#' @param equal.ylims logical indicating if the same y-limits must be used when plotting the fitted additive terms. It can be overriden by non-NULL values for \code{ylim1} or \code{ylim2}. (Default: TRUE).
#' @param ylim1 Vector of length 2 specifying (common) y-axis limits when plotting the fitted additive term(s) in the long-term survival submodel. (Default: NULL).
#' @param ylim2 Vector of length 2 specifying (common) y-axis limits when plotting the fitted additive term(s) in the short-term survival submodel. (Default: NULL).
#' @param ... additional generic plotting arguments.
#'
#' @details Plot of the fitted additive terms, as well as of the reference hazard \eqn{f_0(t)} and cumulative hazard \eqn{F_0(t)} functions of the fitted tvcure model in \code{x}.
#'
#' @return In addition to the plots, an invisible list generated by the \code{\link{additive.tvcure}} function is returned.
#'
#' @author Philippe Lambert \email{p.lambert@uliege.be} based on the plot.gam function in mgcv for the \code{pages} argument.
#' @references Lambert, P. and Kreyenfeld, M. (2024). Exogenous time-varying covariates in double additive cure survival model
#' with application to fertility. \emph{Journal of the Royal Statistical Society, Series A}, under review.
#'
#' @examples
#' require(tvcure)
#' ## Simulated data generation
#' beta = c(beta0=.4, beta1=-.2, beta2=.15) ; gam = c(gam1=.2, gam2=.2)
#' df.raw = simulateTVcureData(n=500, seed=123, beta=beta, gam=gam,
#'                           RC.dist="exponential",mu.cens=550)$df.raw
#' ## TVcure model fitting
#' tau.0 = 2.7 ; lambda1.0 = c(40,15) ; lambda2.0 = c(25,70) ## Optional
#' model = tvcure(~z1+z2+s(x1)+s(x2), ~z3+z4+s(x3)+s(x4), df=df.raw,
#'                tau.0=tau.0, lambda1.0=lambda1.0, lambda2.0=lambda2.0)
#' plot(model,pages=1)
#'
#' @seealso \code{\link{tvcure}}, \code{\link{tvcure.object}}, \code{\link{print.tvcure}}
#'
#' @export
#'
plot.tvcure = function(x, ngrid=300, ci.level=.95, pages=0, select=NULL, equal.ylims=TRUE, ylim1=NULL, ylim2=NULL,...){
    obj = x
    ## Compute additive term + envelope
    ## --------------------------------
    fhat = additive.tvcure(obj,ngrid=ngrid,ci.level=ci.level)
    ##
    ## Plot organization (extracted from mgcv::plot.gam)
    ## -------------------------------------------------
    if (is.null(select)){
        n.plots = 2 + fhat$J1 + fhat$J2 ## Number of plots: f0, F0 + additive terms
    } else {
        n.plots = 1
        if (select == 0) n.plots = 2
    }
    if (pages > n.plots) pages = n.plots
    if (pages < 0) pages = 0
    if (pages != 0) {
        ppp = n.plots%/%pages
        if (n.plots%%pages != 0) {
            ppp = ppp + 1
            while (ppp * (pages - 1) >= n.plots) pages = pages - 1
        }
        c = r = trunc(sqrt(ppp))
        if (c < 1) r = c = 1
        if (c * r < ppp) c = c + 1
        if (c * r < ppp) r = r + 1
        oldpar = par(mfrow = c(r, c))
    }
    else {
        ppp = 1
        oldpar = par()
    }
    if ((pages == 0 && prod(par("mfcol")) < n.plots && dev.interactive()) ||
        pages > 1 && dev.interactive())
        ask = TRUE
    else ask = FALSE
    if (!is.null(select) && (select!=0)) {
        ask = FALSE
    }
    if (ask) {
        oask = devAskNewPage(TRUE)
        on.exit(devAskNewPage(oask))
    }
    ## Plot baseline f0 & F0
    ## ---------------------
    if (is.null(select) || (select==0)){
        par(mar=c(4,5,1,1))
        beta0 = x$fit$beta[1,1]
        curve(exp(beta0)*fhat$f0(x), xlim=attr(fhat$f0,"support"),
              xlab="time",ylab=bquote(e^{beta[0]}*~f[0](t)))
        ## with(fhat, curve(f0,
        ##                  xlim=attr(f0,"support"),xlab="time",ylab=bquote(e^{beta[0]}*~f[0](t))))
        with(fhat, curve(F0, xlim=attr(F0,"support"),
                         xlab="time",ylab=bquote(F[0](t))))
    }
    ## Plot Additive terms
    ## -------------------
    plotAdd = function(x,y,...) matplot(x, y,type="l",
                                        ylim=ylims,xlab=xlab,ylab=ylab,
                                        lwd=c(2,1,1),lty=c(1,2,2),col=1, ...)
    if (fhat$J1 > 0){
        ylims = NULL
        if (equal.ylims) ylims =  range(lapply(fhat$f1.grid, function(x) range(x$y.mat)))
        if (!is.null(ylim1)) ylims = ylim1
        for (j in 1:fhat$J1){
            if ((is.null(select)) || (select == j)){
                par(mar=c(4,5,1,1))
                xlab = names(fhat$f1.grid)[j]
                ylab = bquote('f'[.(j)]*(.(xlab)))
                with(fhat$f1.grid[[j]], plotAdd(x, y.mat, ...))
            }
        }
    }
    if (fhat$J2 > 0){
        ylims = NULL
        if (equal.ylims) ylims =  range(lapply(fhat$f2.grid, function(x) range(x$y.mat)))
        if (!is.null(ylim2)) ylims = ylim2
        for (j in 1:fhat$J2){
            if ((is.null(select)) || (select == fhat$J1+j)){
                par(mar=c(4,5,1,1))
                xlab = names(fhat$f2.grid)[j]
                ylab = bquote(tilde('f')[.(j)]*(.(xlab)))
                with(fhat$f2.grid[[j]], plotAdd(x, y.mat, ...))
            }
        }
    }
    if (pages > 0) par(oldpar)
    return(invisible(fhat))
}
